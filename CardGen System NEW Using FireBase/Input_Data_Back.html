<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="root.css">
    <link rel="stylesheet" href="Toast.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
    <style>
        body {
            background: var(--background-color);
            margin: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
        }
        .navbar {
            z-index: 1060 !important;
            font-family: 'Oswald', sans-serif;
            background: var(--primary-color) !important;
        }
        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s;
            padding-right: 1rem;
            padding-top: 0;
        }
        @media (min-width: 992px) {
            .main-content { margin-left: 250px; padding-right: 2rem; }
            #toggleBtn { display: none; }
            .sidebar { transform: translateX(0) !important; }
        }
        @media (max-width: 991.98px) {
            .sidebar { position: absolute; height: 100vh; }
        }
        @media (max-width: 768px) {
            .button-row { flex-direction: column; }
            .btn-group-left { flex-direction: column; }
            .hot-container { height: 250px; }
        }
        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--secondary-color);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1050;
            font-family: 'Poppins', sans-serif;
            padding-top: 60px;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar .nav-link {
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            color: var(--primary-color);
        }
        .sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: bold;
            transform: translateX(5px);
            pointer-events: none;
        }
        .sidebar .nav-item p {
            font-family: Poppins;
            font-weight: bold;
            color: var(--primarydark-color);
        }
        #toggleBtn {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        #toggleBtn:hover {
            background-color: var(--secondary-color) !important;
            color: var(--primary-color) !important;
            border-color: var(--secondary-color) !important;
        }
        .button-row { margin-bottom: 20px; }
        .btn-group-left { display: flex; gap: 10px; }
        .btn-right { margin-left: auto; }
        .hot-container { height: 300px; border: 1px solid var(--primarydark-color); margin-bottom: 20px; overflow: auto; }
        .student-table { height: 300px; }
        .signature-preview { max-width: 200px; max-height: 100px; margin: 10px 0; border: 1px solid var(--background-color); }
        .remove-signature {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: var(--secondary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }
        .metadata-table { height: 250px; }
        .htInvalid { background-color: var(--background-color) !important; border: 2px solid #f44336 !important; }
        .space { height: 20px; }
        .btn .btn-secondary { background-color: var(--danger) !important; }
        .handsontable thead th .relative { background-color: var(--accent-color); border: 1px solid var(--primarydark-color); }
        .handsontable table { border-collapse: collapse; border: 1px solid var(--primarydark-color); }
        .ht_master tb { background-color: var(--accent-color); border: 1px solid var(--primarydark-color); }
        .btn-primary { background-color: var(--primary-color) !important; border-color: var(--primarydark-color); }
    </style>
    <script>
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser || currentUser.role !== "Chris") window.location.href = "index.html";
    </script>
</head>
<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div class="d-flex flex-column flex-lg-row w-100 align-items-start align-items-lg-center justify-content-lg-between">
                <div class="d-flex align-items-center w-100 w-lg-auto justify-content-start mb-2 mb-lg-0">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">â˜°</button>
                    <span class="navbar-brand mb-0 h1 d-none d-lg-inline">CardGen: From Grade Consolidation to Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 d-inline d-lg-none">CardGen 2025</span>
                </div>
            </div>
        </div>
    </nav>
    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <li class="nav-item"><p>School Form 9</p></li>
            <li class="nav-item"><a class="nav-link" href="front_card.html">Front Card</a></li>
            <li class="nav-item"><a class="nav-link" href="Back_Card.html">Back Card</a></li>
            <li class="nav-item"><p>Input Data</p></li>
            <li class="nav-item"><a class="nav-link" href="input_data.html">Input Data</a></li>
            <li class="nav-item"><a class="nav-link active fw-bold" href="#">Input Data (First Sem)</a></li>
            <li class="nav-item"><a class="nav-link no-link" href="#">Attendance</a></li>
            <li class="nav-item"><a class="nav-link no-link" href="#">Core-Values</a></li>
            <li class="nav-item"><button onclick="logout()" class="nav-link">Logout</button></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <h2 style="text-align:center;">Student Metadata Overview</h2>
                    <div id="summaryHot" class="hot-container"></div>
                    <div id="subjectList" class="hot-container"></div>
                    <h5>Boys Data</h5>
                    <div id="boysHot" class="hot-container student-table"></div>
                    <h5>Girls Data</h5>
                    <div id="girlsHot" class="hot-container student-table"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById('subjectList');

    const savedData = JSON.parse(localStorage.getItem('sem1_SubjectData')) || [
        ['', 'Core Subject', 'Applied and Specialized Subjects'],
        ['1st Subject', '', ''],
        ['2nd Subject', '', ''],
        ['3rd Subject', '', ''],
        ['4th Subject', '', ''],
        ['5th Subject', '', ''],
        ['6th Subject', '', ''],
        ['7th Subject', '', ''],
        ['8th Subject', '', ''],
    ];

    function cleanTableData(data) {
        return data.map(row =>
            row.map(cell => (cell === null ? "" : cell))
        );
    }

    const hot = new Handsontable(container, {
        data: savedData,
        rowHeaders: false,
        colHeaders: false,
        fixedRowsTop: 1,
        fixedColumnsLeft: 1,
        stretchH: 'all',
        manualRowResize: true,
        manualColumnResize: true,
        height: 'auto',
        licenseKey: 'non-commercial-and-evaluation',

        cells: function (row, col) {
            const cellProperties = {};
            if (row === 0 || col === 0) {
                cellProperties.readOnly = true;
            }
            return cellProperties;
        },

        afterChange: function (changes, source) {
            if (source === 'loadData') return;
            const cleaned = cleanTableData(this.getData());
            localStorage.setItem('sem1_SubjectData', JSON.stringify(cleaned));
        }
    });
});

        document.addEventListener('DOMContentLoaded', function() {
            const boysNames = JSON.parse(localStorage.getItem("boysData"))?.map(r => r[0].trim()) || [];
            const girlsNames = JSON.parse(localStorage.getItem("girlsData"))?.map(r => r[0].trim()) || [];
            const subjectLabels = ["1st","2nd","3rd","4th","5th","6th","7th","8th"];
            const mergeAnchors = [1,4,7,10,13,16,19,22,25,28,31,34,37,40,43,46];

            function createTableData(names, storageKey) {
                const headerRows = [];
                const row0 = Array(50).fill("");
                row0[0] = "Names of Learners";
                for (let i = 1; i <= 24; i++) row0[i] = "Core Subjects";
                for (let i = 25; i <= 48; i++) row0[i] = "Applied & Specialized Subjects";
                row0[49] = "Gen Ave";
                headerRows.push(row0);

                const row1 = Array(50).fill("");
                subjectLabels.forEach((s, idx) => row1[1 + idx*3] = `${s} Subject`);
                subjectLabels.forEach((s, idx) => row1[25 + idx*3] = `${s} Subject`);
                headerRows.push(row1);

                const row2 = Array(50).fill("");
                mergeAnchors.forEach(c => { row2[c] = "QUARTER"; row2[c+2] = "Final Sem"; });
                headerRows.push(row2);

                const row3 = Array(50).fill("");
                mergeAnchors.forEach(c => { row3[c] = "1"; row3[c+1] = "2"; });
                headerRows.push(row3);

                const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");
                const studentRows = names.map(name => {
                    const row = [name, ...Array(49).fill("")];
                    const lookup = saved[name];
                    if (lookup) {
                        for (let s = 0; s < 8; s++) {
                            const startCol = 1 + s*3;
                            const sub = lookup.core?.[`Subject ${s+1}`] || {};
                            row[startCol] = sub["1st Quarter"] || "";
                            row[startCol+1] = sub["2nd Quarter"] || "";
                            row[startCol+2] = sub["Final Sem"] || "";
                        }
                        for (let s = 0; s < 8; s++) {
                            const startCol = 25 + s*3;
                            const sub = lookup.applied?.[`Subject ${s+1}`] || {};
                            row[startCol] = sub["1st Quarter"] || "";
                            row[startCol+1] = sub["2nd Quarter"] || "";
                            row[startCol+2] = sub["Final Sem"] || "";
                        }
                        row[49] = lookup["Gen Ave"] || "";
                    }
                    return row;
                });
                return headerRows.concat(studentRows);
            }

            const mergeCellsConfig = [
                { row:0, col:0, rowspan:4, colspan:1 },
                { row:0, col:1, rowspan:1, colspan:24 },
                { row:0, col:25, rowspan:1, colspan:24 },
                { row:0, col:49, rowspan:4, colspan:1 },
                ...mergeAnchors.map(c => ({ row:1, col:c, rowspan:1, colspan:3 })),
                ...mergeAnchors.flatMap(c => [{ row:2, col:c, rowspan:1, colspan:2 }, { row:2, col:c+2, rowspan:2, colspan:1 }])
            ];

            const cols = Array(50).fill({ type:'text' });

            function cellReadOnly(instance, row, col) { return row < 4 || col === 0; }
            function cellClassNames(instance, row, col) { if (row < 4) return 'htCenter htBold'; if (col === 0) return 'student-name'; return ''; }

            function computeFinalSemForCell(instance, row, col) {
                if (row < 4) return;
                const isCore = col >= 1 && col <= 24;
                const isApplied = col >= 25 && col <= 48;
                if (!isCore && !isApplied) return;
                const base = isCore ? 1 : 25;
                const subjectOffset = Math.floor((col - base) / 3) * 3;
                const col1 = base + subjectOffset;
                const col2 = base + subjectOffset + 1;
                const col3 = base + subjectOffset + 2;
                const q1 = parseFloat(instance.getDataAtCell(row, col1)) || 0;
                const q2 = parseFloat(instance.getDataAtCell(row, col2)) || 0;
                if (q1 && q2) instance.setDataAtCell(row, col3, Math.round((q1 + q2)/2), "autoCalc");
                else instance.setDataAtCell(row, col3, "", "autoCalc");
            }

            function computeGenAveForStudent(instance, row) {
                if (row < 4) return;
                let total = 0, count = 0;
                for (let s = 0; s < 8; s++) {
                    const val = parseFloat(instance.getDataAtCell(row, 1 + s*3 + 2));
                    if (!isNaN(val) && val !== "") { total += val; count++; }
                }
                for (let s = 0; s < 8; s++) {
                    const val = parseFloat(instance.getDataAtCell(row, 25 + s*3 + 2));
                    if (!isNaN(val) && val !== "") { total += val; count++; }
                }
                instance.setDataAtCell(row, 49, count ? Math.round(total/count) : "", "autoCalc");
            }

            function saveGradesToLocalStorage(instance, storageKey) {
                const grades = {};
                for (let i = 4; i < instance.countRows(); i++) {
                    const studentName = instance.getDataAtCell(i, 0)?.trim();
                    if (!studentName) continue;
                    grades[studentName] = { core: {}, applied: {}, "Gen Ave": "" };
                    for (let s = 0; s < 8; s++) {
                        const startCol = 1 + s*3;
                        grades[studentName].core[`Subject ${s+1}`] = {
                            "1st Quarter": instance.getDataAtCell(i, startCol) || "",
                            "2nd Quarter": instance.getDataAtCell(i, startCol+1) || "",
                            "Final Sem": instance.getDataAtCell(i, startCol+2) || ""
                        };
                    }
                    for (let s = 0; s < 8; s++) {
                        const startCol = 25 + s*3;
                        grades[studentName].applied[`Subject ${s+1}`] = {
                            "1st Quarter": instance.getDataAtCell(i, startCol) || "",
                            "2nd Quarter": instance.getDataAtCell(i, startCol+1) || "",
                            "Final Sem": instance.getDataAtCell(i, startCol+2) || ""
                        };
                    }
                    grades[studentName]["Gen Ave"] = instance.getDataAtCell(i, 49) || "";
                }
                localStorage.setItem(storageKey, JSON.stringify(grades));
            }

            function initTable(container, names, storageKey) {
                return new Handsontable(container, {
                    data: createTableData(names, storageKey),
                    colHeaders: false,
                    rowHeaders: i => (i >= 4 ? i-3 : ""),
                    licenseKey: 'non-commercial-and-evaluation',
                    stretchH: 'all',
                    mergeCells: mergeCellsConfig,
                    columns: cols,
                    editor: 'text',
                    manualRowResize: true,
                    manualColumnResize: true,
                    cells: (row, col) => ({
                        readOnly: cellReadOnly(this, row, col),
                        className: cellClassNames(this, row, col)
                    }),
                    afterChange: function(changes, source) {
                        if (!changes || source === 'loadData' || source === 'autoCalc') return;
                        changes.forEach(([row, col]) => {
                            computeFinalSemForCell(this, row, col);
                            computeGenAveForStudent(this, row);
                        });
                        saveGradesToLocalStorage(this, storageKey);
                    }
                });
            }

            function renderMetadataOverview(containerId) {
                const savedMetadata = JSON.parse(localStorage.getItem('metadataData')) || [];
                const displayLabels = ['Adviser:', 'Grade:', 'Section:', 'School Year:', 'Track:', 'Strand:', 'Principal:'];
                const displayData = displayLabels.map(label => {
                    const found = savedMetadata.find(row => row[0] === label);
                    return [label, found ? (found[1] || '') : ''];
                });
                new Handsontable(document.getElementById(containerId), {
                    data: displayData,
                    colHeaders: ['Label', 'Value'],
                    rowHeaders: false,
                    licenseKey: 'non-commercial-and-evaluation',
                    stretchH: 'all',
                    colWidths: [150, 400],
                    readOnly: true,
                    cells: (row, col) => ({
                        readOnly: true,
                        className: col === 0 ? 'htReadOnly htCenter' : ''
                    })
                });
            }

            renderMetadataOverview('summaryHot');
            initTable(document.getElementById('boysHot'), boysNames, "sem1GradesData_boys");
            initTable(document.getElementById('girlsHot'), girlsNames, "sem1GradesData_girls");
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
    <script src="SideBar-NavBar.js"></script>
    <script src="Logout.js"></script>
    <script src="Toast.js"></script>
</body>
</html>
