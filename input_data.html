<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="root.css">
    <link rel="stylesheet" href="Toast.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <style>
        body {
            background: var(--background-color);
            margin: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
        }
        .navbar {
            z-index: 1060 !important;
            font-family: 'Oswald', sans-serif;
            background: var(--primary-color) !important;
        }
        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s;
            padding-right: 1rem;
            padding-top: 0;
        }
        @media (min-width: 992px) {
            .main-content { margin-left: 250px; padding-right: 2rem; }
            #toggleBtn { display: none; }
            .sidebar { transform: translateX(0) !important; }
        }
        @media (max-width: 991.98px) {
            .sidebar { position: absolute; height: 100vh; }
        }
        @media (max-width: 768px) {
            .button-row { flex-direction: column; }
            .btn-group-left { flex-direction: column; }
            .hot-container { height: 250px; }
        }
        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--secondary-color);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1050;
            font-family: 'Poppins', sans-serif;
            padding-top: 60px;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar .nav-link {
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            color: var(--primary-color);
        }
        .sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: bold;
            transform: translateX(5px);
            pointer-events: none;
        }
        .sidebar .nav-item p {
            font-family: Poppins;
            font-weight: bold;
            color: var(--primarydark-color);
        }
        #toggleBtn {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        #toggleBtn:hover {
            background-color: var(--secondary-color) !important;
            color: var(--primary-color) !important;
            border-color: var(--secondary-color) !important;
        }
        .button-row { margin-bottom: 20px; }
        .btn-group-left { display: flex; gap: 10px; }
        .btn-right { margin-left: auto; }
        .hot-container { height: 300px; border: 1px solid var(--primarydark-color); margin-bottom: 20px; overflow: auto; }
        .student-table { height: 300px; }
        .signature-preview { max-width: 200px; max-height: 100px; margin: 10px 0; border: 1px solid var(--background-color); }
        .remove-signature {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: var(--secondary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }
        .metadata-table { height: 250px; }
        .htInvalid { background-color: var(--background-color) !important; border: 2px solid #f44336 !important; }
        .space { height: 20px; }
        .btn .btn-secondary { background-color: var(--danger) !important; }
        .handsontable thead th .relative { background-color: var(--accent-color); border: 1px solid var(--primarydark-color); }
        .handsontable table { border-collapse: collapse; border: 1px solid var(--primarydark-color); }
        .ht_master tb { background-color: var(--accent-color); border: 1px solid var(--primarydark-color); }
        .btn-primary {background-color: var(--primary-color) !important; border-color: var(--primarydark-color);}
    </style>

    <script src="Adviser_Acc_Security.js"></script>
    
</head>
<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div class="d-flex flex-column flex-lg-row w-100 align-items-start align-items-lg-center justify-content-lg-between">
                <div class="d-flex align-items-center w-100 w-lg-auto justify-content-start mb-2 mb-lg-0">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">â˜°</button>
                    <span class="navbar-brand mb-0 h1 d-none d-lg-inline">CarGen: From Grade Consolidation to Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 d-inline d-lg-none">CarGen 2025</span>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <li class="nav-item"><p>School Form 9</p></li>
            <li class="nav-item"><a class="nav-link" href="front_card.html">Front Card</a></li>
            <li class="nav-item"><a class="nav-link" href="Back_Card.html">Back Card</a></li>
            <li class="nav-item"><p>Input Data</p></li>
            <li class="nav-item"><a class="nav-link active fw-bold" href="">Input Data</a></li>
            <li class="nav-item"><a class="nav-link" href="Input_Data_Back.html">Input Data (First Sem)</a></li>
            <li class="nav-item"><a class="nav-link no-link" href="#">Attendance</a></li>
            <li class="nav-item"><a class="nav-link no-link" href="#">Core-Values</a></li>
            <li class="nav-item"><button onclick="logout()" class="nav-link">Logout</button></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex button-row">
                        <div class="btn-group-left">
                            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Data</button>
                            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none" onchange="importData(event)">
                        </div>
                        <button class="btn btn-danger btn-right" onclick="showClearConfirmation()">Clear Data</button>
                    </div>

                    <div id="metadataHot" class="hot-container metadata-table"></div>
                    <div class="space"></div>

                    <h5>Boys Data</h5>
                    <div id="boysHot" class="hot-container student-table"></div>
                    <div class="space"></div>

                    <h5>Girls Data</h5>
                    <div id="girlsHot" class="hot-container student-table"></div>

                    <div class="d-flex button-row">
                        <div class="btn-group-left">
                            <button class="btn btn-info" onclick="document.getElementById('teacherSigFile').click()">Upload Teacher Signature</button>
                            <input type="file" id="teacherSigFile" accept="image/png" style="display:none" onchange="uploadSignature(event, 'teacher')">
                            <div id="teacherSigPreview" style="position:relative; display:inline-block;"></div>

                            <button class="btn btn-info" onclick="document.getElementById('principalSigFile').click()">Upload Principal Signature</button>
                            <input type="file" id="principalSigFile" accept="image/png" style="display:none" onchange="uploadSignature(event, 'principal')">
                            <div id="principalSigPreview" style="position:relative; display:inline-block;"></div>
                        </div>
                        <button class="btn btn-warning btn-right" onclick="clearStudentData()">Clear</button>
                    </div>

                    <div class="modal fade" id="clearModal" tabindex="-1" style="z-index: 1080">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirm Clear Data</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">Are you sure you want to clear all data? This cannot be undone.</div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" onclick="confirmClearData()">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

<script>
let metadataHot, boysHot, girlsHot;
const MAX_FILE_SIZE = 2*1024*1024;

function lrnValidator(value, callback) {
  callback(!value || /^\d{12}$/.test(value));
}

function createStudentData() {
  return Array.from({length:50}, () => Array(7).fill(''));
}

function applyUpperCase(hotInstance) {
  hotInstance.addHook('beforeChange', (changes) => {
    if (!changes) return;
    changes.forEach(change => {
      if (change[3] && typeof change[3] === 'string') change[3] = change[3].toUpperCase();
    });
  });
}

function preventNulls(hotInstance) {
  hotInstance.addHook('beforeChange', (changes) => {
    if (!changes) return;
    changes.forEach(change => { if (change[3] === null) change[3] = ''; });
  });
}

function fixNullsSilent(hotInstance) {
  hotInstance.addHook('afterChange', (changes, source) => {
    if (!changes || source==='loadData') return;
    let touched = false;
    const data = hotInstance.getData();
    changes.forEach(([r,p,o,n]) => { if (n===null) { data[r][p]=''; touched=true; } });
    if (touched) hotInstance.render();
  });
}

function autoSaveStudents() {
  const fillSex = (rows, sex) => rows.map(row => { while(row.length<7) row.push(''); row[2] = row[2] || sex; return row; });
  localStorage.setItem("metadataData", JSON.stringify(metadataHot.getData()));
  localStorage.setItem("boysData", JSON.stringify(fillSex(boysHot.getData(),'MALE')));
  localStorage.setItem("girlsData", JSON.stringify(fillSex(girlsHot.getData(),'FEMALE')));
}

document.addEventListener('DOMContentLoaded', function() {
  const metadataData=[['Track:',''],['Strand:',''],['School Year:',''],['Adviser:',''],['Principal:',''],['Section:',''],['Grade:','']];
  metadataHot = new Handsontable(document.getElementById('metadataHot'), {
    data: metadataData, colHeaders:['Label','Input'], rowHeaders:true,
    licenseKey:'non-commercial-and-evaluation', colWidths:[150,400], stretchH:'all',
    cells:(row,col)=>({ readOnly: col===0, className: col===0?'htReadOnly':'' , type: col===0?'text':'text'})
  });

  const studentHeaders=['Name','Age','Sex','LRN','Parent','Parent Number','Parent Gmail'];

  boysHot = new Handsontable(document.getElementById('boysHot'), {
    data:createStudentData(), colHeaders:studentHeaders,rowHeaders:true,
    licenseKey:'non-commercial-and-evaluation',stretchH:'all',contextMenu:true,manualRowResize:true,manualColumnResize:true,
    hiddenColumns:{columns:[2],indicators:false},
    columns:[{type:'text'},{type:'numeric'},{type:'text',readOnly:true},{type:'text',validator:lrnValidator,allowInvalid:true},{type:'text'},{type:'text'},{type:'text'}]
  });

  girlsHot = new Handsontable(document.getElementById('girlsHot'), {
    data:createStudentData(), colHeaders:studentHeaders,rowHeaders:true,
    licenseKey:'non-commercial-and-evaluation',stretchH:'all',contextMenu:true,manualRowResize:true,manualColumnResize:true,
    hiddenColumns:{columns:[2],indicators:false},
    columns:[{type:'text'},{type:'numeric'},{type:'text',readOnly:true},{type:'text',validator:lrnValidator,allowInvalid:true},{type:'text'},{type:'text'},{type:'text'}]
  });

  const savedBoys=JSON.parse(localStorage.getItem("boysData"))||createStudentData();
  const savedGirls=JSON.parse(localStorage.getItem("girlsData"))||createStudentData();
  const savedMetadata=JSON.parse(localStorage.getItem("metadataData"))||metadataHot.getData();

  boysHot.loadData(savedBoys); girlsHot.loadData(savedGirls); metadataHot.loadData(savedMetadata);

  metadataHot.addHook('afterChange', autoSaveStudents);
  boysHot.addHook('afterChange', autoSaveStudents);
  girlsHot.addHook('afterChange', autoSaveStudents);

  applyUpperCase(metadataHot);
  applyUpperCase(boysHot);
  applyUpperCase(girlsHot);

  preventNulls(boysHot);
  preventNulls(girlsHot);
  fixNullsSilent(boysHot);
  fixNullsSilent(girlsHot);
});

function getPreparedDataForExport(hotInstance, defaultSex) {
  return hotInstance.getData().map(row => [
    row[0]||'', row[1]||'', row[2]||(row[0]?defaultSex:''), row[3]||'', row[4]||'', row[5]||'', row[6]||'', row[7]||'', row[8]||''
  ]);
}

function exportData() {
    const wb = XLSX.utils.book_new();

    const metadata = metadataHot.getData();
    const boys = getPreparedDataForExport(boysHot, 'MALE');
    const girls = getPreparedDataForExport(girlsHot, 'FEMALE');

    const spacer = [[""]];      
    const spacer3 = [[""], [""], [""]];   

    const allData = [
        ["Main Information"],
        ...metadata,
        ...spacer3,
        ["BOYS"],
        ...boys,
        ...spacer3,
        ["GIRLS"],
        ...girls
    ];

    const sheet = XLSX.utils.aoa_to_sheet(allData);

    XLSX.utils.book_append_sheet(wb, sheet, "AllData");
    XLSX.writeFile(wb, "CertificateData.xlsx");
}

function importData(event) {
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:'array'});
    if(wb.SheetNames.includes('Metadata')){
      const raw=XLSX.utils.sheet_to_json(wb.Sheets['Metadata'],{header:1});
      metadataHot.loadData([['Track:',raw[0][1]||''],['Strand:',raw[1][1]||''],['School Year:',raw[2][1]||''],['Adviser:',raw[3][1]||''],['Principal:',raw[4][1]||''],['Section:',raw[5][1]||''],['Grade:',raw[6][1]||'']]);
    }
    if(wb.SheetNames.includes('Boys')){ boysHot.loadData(XLSX.utils.sheet_to_json(wb.Sheets['Boys'],{header:1})); boysHot.render(); }
    if(wb.SheetNames.includes('Girls')){ girlsHot.loadData(XLSX.utils.sheet_to_json(wb.Sheets['Girls'],{header:1})); girlsHot.render(); }
    autoSaveStudents();
  };
  reader.readAsArrayBuffer(file);
  event.target.value='';
}

function showClearConfirmation() { new bootstrap.Modal(document.getElementById('clearModal')).show(); }

function confirmClearData() {
  metadataHot.loadData(metadataHot.getData().map(row=>row.map((cell,col)=>col===0?cell:'')));
  boysHot.loadData(createStudentData());
  girlsHot.loadData(createStudentData());
  localStorage.removeItem("metadataData");
  localStorage.removeItem("boysData");
  localStorage.removeItem("girlsData");
  metadataHot.render();
  boysHot.render();
  girlsHot.render();
  bootstrap.Modal.getInstance(document.getElementById('clearModal')).hide();
  alert('All data cleared!');
}

function clearStudentData() {
  localStorage.removeItem("boysData");
  localStorage.removeItem("girlsData");
  boysHot.loadData(createStudentData());
  girlsHot.loadData(createStudentData());
  boysHot.render();
  girlsHot.render();
  alert('Student data cleared!');
}

function uploadSignature(event,type){
  const file=event.target.files[0];
  if(!file||file.type!=='image/png'){ alert('Select PNG only'); return; }
  if(file.size>MAX_FILE_SIZE){ alert('Max 2MB'); return; }
  const reader=new FileReader();
  reader.onload=e=>{
    const preview=document.getElementById(type==='teacher'?'teacherSigPreview':'principalSigPreview');
    preview.innerHTML=`<img src="${e.target.result}" class="signature-preview"><span class="remove-signature" onclick="removeSignature('${type}')">&times;</span>`;
  };
  reader.readAsDataURL(file);
  event.target.value='';
}

function removeSignature(type){ document.getElementById(type==='teacher'?'teacherSigPreview':'principalSigPreview').innerHTML=''; }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="SideBar-NavBar.js"></script>
<script src="Logout.js"></script>
<script src="Toast.js"></script>
</body>
</html>
